# System pipeline - processes system/DevOps logs
input {
  tcp {
    port => 5001
    codec => json
    tags => ["system"]
  }
  
  # Beats input for Kubernetes logs
  beats {
    port => 5044
    tags => ["system", "beats"]
  }
}

filter {
  if "system" in [tags] {
    mutate {
      add_field => { "[@metadata][index_prefix]" => "system" }
    }
    
    # Determine specific index based on log type
    if [kubernetes] or [k8s] {
      mutate {
        add_field => { "[@metadata][index_type]" => "k8s" }
      }
    } else if [deployment] or [rollout] {
      mutate {
        add_field => { "[@metadata][index_type]" => "deployment" }
      }
    } else {
      mutate {
        add_field => { "[@metadata][index_type]" => "api" }
      }
    }
    
    # Parse Kubernetes metadata
    if [kubernetes][namespace] {
      mutate {
        add_field => { "k8s_namespace" => "%{[kubernetes][namespace]}" }
      }
    }
    
    # Add timestamp if missing
    if ![timestamp] {
      date {
        match => [ "timestamp", "ISO8601", "yyyy-MM-dd'T'HH:mm:ss.SSSZ" ]
        target => "@timestamp"
      }
    }
  }
}

output {
  if "system" in [tags] {
    elasticsearch {
      hosts => ["http://elasticsearch:9200"]
      index => "system-%{[@metadata][index_type]}-%{+YYYY.MM.dd}"
    }
  }
}
