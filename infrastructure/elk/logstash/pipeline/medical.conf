# Medical pipeline - processes medical-related logs
input {
  tcp {
    port => 5000
    codec => json
    tags => ["medical"]
  }
}

filter {
  if "medical" in [tags] {
    # Parse common medical fields
    if [patient_id] {
      mutate {
        add_field => { "[@metadata][index_prefix]" => "medical" }
      }
    }
    
    # Determine specific index based on event type
    if [heart_rate] or [spo2] or [temperature] {
      mutate {
        add_field => { "[@metadata][index_type]" => "vitals" }
      }
    } else if [alert_type] or [severity] =~ /^(critical|warning|info)$/ {
      mutate {
        add_field => { "[@metadata][index_type]" => "alerts" }
      }
    } else if [summary_text] {
      mutate {
        add_field => { "[@metadata][index_type]" => "summaries" }
      }
    } else {
      mutate {
        add_field => { "[@metadata][index_type]" => "events" }
      }
    }
    
    # Add timestamp if missing
    if ![timestamp] {
      date {
        match => [ "timestamp", "ISO8601", "yyyy-MM-dd'T'HH:mm:ss.SSSZ" ]
        target => "@timestamp"
      }
    }
  }
}

output {
  if "medical" in [tags] {
    elasticsearch {
      hosts => ["http://elasticsearch:9200"]
      index => "medical-%{[@metadata][index_type]}-%{+YYYY.MM.dd}"
    }
  }
}
