---
# Backend Role - Deploy healthcare services to Kubernetes
- name: Create healthcare namespace
  command: kubectl apply -f {{ playbook_dir }}/../../../kubernetes/namespace.yaml
  environment:
    KUBECONFIG: /root/.kube/config

- name: Apply ConfigMaps
  command: kubectl apply -f {{ playbook_dir }}/../../../kubernetes/configmaps/
  environment:
    KUBECONFIG: /root/.kube/config

- name: Apply Secrets
  command: kubectl apply -f {{ playbook_dir }}/../../../kubernetes/secrets/
  environment:
    KUBECONFIG: /root/.kube/config

- name: Deploy backend services
  command: kubectl apply -f {{ playbook_dir }}/../../../kubernetes/deployments/
  environment:
    KUBECONFIG: /root/.kube/config

- name: Apply Ingress
  command: kubectl apply -f {{ playbook_dir }}/../../../kubernetes/ingress/
  environment:
    KUBECONFIG: /root/.kube/config

- name: Apply HPA
  command: kubectl apply -f {{ playbook_dir }}/../../../kubernetes/hpa/
  environment:
    KUBECONFIG: /root/.kube/config

- name: Wait for deployments to be ready
  command: kubectl rollout status deployment/{{ item }} -n healthcare --timeout=300s
  environment:
    KUBECONFIG: /root/.kube/config
  loop:
    - vitals-generator
    - alert-engine
    - summarizer-service
    - frontend
